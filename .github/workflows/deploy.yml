name: Deploy FastAPI Application (Simple)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CONTAINER_NAME: fastapi-production
  IMAGE_NAME: singhgurvinder23/testfastapipython
  PORT: 8000

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull latest image
        run: |
          docker pull ${{ env.IMAGE_NAME }}:latest

      - name: Stop and remove existing container
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

      - name: Run new container
        run: |
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.PORT }}:8000 \
            -e ENVIRONMENT=production \
            ${{ env.IMAGE_NAME }}:latest

      - name: Wait for container to be healthy
        run: |
          echo "Waiting for container to start..."
          sleep 10
          
          # Check if container is running
          if ! docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "Container failed to start"
            docker logs ${{ env.CONTAINER_NAME }}
            exit 1
          fi

      - name: Verify deployment
        run: |
          echo "Testing health endpoint..."
          for i in {1..30}; do
            if curl -f http://localhost:${{ env.PORT }}/health; then
              echo "Service is healthy!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 2
          done
          echo "Service health check failed"
          exit 1

      - name: Show running containers
        run: |
          docker ps -a

      - name: Show container logs
        if: always()
        run: |
          docker logs --tail=100 ${{ env.CONTAINER_NAME }} || true

      - name: Cleanup old images
        run: |
          docker image prune -af || true
